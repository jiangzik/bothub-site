name: Deploy Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Resolve base URL
        run: |
          if [ -f CNAME ]; then
            echo "NUXT_APP_BASE_URL=/" >> "$GITHUB_ENV"
          else
            echo "NUXT_APP_BASE_URL=/${{ github.event.repository.name }}/" >> "$GITHUB_ENV"
          fi

      - name: Build static site
        run: npx nuxi generate

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: .output/public

      - name: Upload site artifact for server deploy
        uses: actions/upload-artifact@v4
        with:
          name: static-site
          path: .output/public
          if-no-files-found: error

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  deploy-cn-server:
    needs: build
    runs-on: ubuntu-latest
    env:
      DEPLOY_HOST: ${{ secrets.CN_DEPLOY_HOST }}
      DEPLOY_USER: ${{ secrets.CN_DEPLOY_USER }}
      DEPLOY_PORT: ${{ secrets.CN_DEPLOY_PORT }}
      DEPLOY_KNOWN_HOSTS: ${{ secrets.CN_DEPLOY_KNOWN_HOSTS }}
      DEPLOY_PATH: ${{ vars.CN_DEPLOY_PATH }}
      CN_DEPLOY_SSH_KEY: ${{ secrets.CN_DEPLOY_SSH_KEY }}
    steps:
      - name: Check CN deploy config
        id: check-cn-deploy
        run: |
          set -euo pipefail
          if [ -z "${DEPLOY_HOST:-}" ] || [ -z "${DEPLOY_USER:-}" ] || [ -z "${CN_DEPLOY_SSH_KEY:-}" ]; then
            echo "enabled=false" >> "$GITHUB_OUTPUT"
            echo "CN deploy skipped: missing CN_DEPLOY_HOST/CN_DEPLOY_USER/CN_DEPLOY_SSH_KEY."
          else
            echo "enabled=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Download site artifact
        if: ${{ steps.check-cn-deploy.outputs.enabled == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: static-site
          path: dist

      - name: Prepare SSH
        if: ${{ steps.check-cn-deploy.outputs.enabled == 'true' }}
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "$CN_DEPLOY_SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          PORT="${DEPLOY_PORT:-22}"
          if [ -n "${DEPLOY_KNOWN_HOSTS:-}" ]; then
            printf '%s\n' "$DEPLOY_KNOWN_HOSTS" > ~/.ssh/known_hosts
          else
            ssh-keyscan -p "$PORT" "$DEPLOY_HOST" >> ~/.ssh/known_hosts
          fi
          chmod 644 ~/.ssh/known_hosts
      - name: Sync files to CN server
        if: ${{ steps.check-cn-deploy.outputs.enabled == 'true' }}
        run: |
          set -euo pipefail
          PORT="${DEPLOY_PORT:-22}"
          TARGET_PATH="${DEPLOY_PATH:-/data/bothub/website}"
          TARGET="$DEPLOY_USER@$DEPLOY_HOST"
          SSH_ARGS="-i ~/.ssh/id_ed25519 -p $PORT -o StrictHostKeyChecking=yes"

          ssh $SSH_ARGS "$TARGET" "mkdir -p '$TARGET_PATH'"
          rsync -az --delete -e "ssh $SSH_ARGS" dist/ "$TARGET:$TARGET_PATH/"
